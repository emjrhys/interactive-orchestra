<!DOCTYPE html>
<html>
    <head>
        <title>Interactive Orchestra</title>
        <link rel="stylesheet" type="text/css" href="main.css">
        <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.4.11/d3.min.js"></script>
        <script>
            var currTime = 0;

            function getTime() {
                    var music = document.getElementById("track");
                    currTime = music.currentTime;
                    $("#duration").prepend(music.currentTime + ' / ' + music.duration + "<br/>");
            }
        </script>
    </head>
    <body>
        <audio id="track" src="assets/afterthestorm.mp3" ontimeupdate="getTime();">
            <p>Your browser does not support the audio element! Please use another browser for the full experience</p>
    </audio>
        <div id="main-container">
            <div id="duration"></div>
            <div class="splash">
                <button id="play"></button>
            </div>
            <button id="stop"></button>
            
            
        </div>

    
        <script>
            $(document).ready(function() {
                $("#track").ready(function() {
                    $("#play").css("display", "inline-block");
                });

                var selected = "";
                var playing = false;

                var times = [12.2, 20.1, 25.2, "27.3"];
                var insts = ["harp", "cello", "flute", "piccolo"];
                
                var next = 0;

                var prevPos = -500;
                
                function createInst(n) {
                    d3.select("#main-container").append("div")
                        .attr("class", "inst " + insts[n])
                        .attr("title", insts[n]);

                    var xpos = prevPos;
                    
                    while (xpos < prevPos + 350 && xpos > prevPos - 350)
                        xpos = Math.random()*(window.innerWidth-300);

                    prevPos = xpos;
                        
                    $("."+insts[n]).css("left", xpos)
                    .click(function() {
                        var title = $(this).attr("title");

                        if (title == selected) selected = "";
                        else selected = title;
                    });
                }
                                    
                $("#play").click(function() {
                    if (!playing) {
                        $(".splash").addClass("playing");
                        document.getElementById('track').play();
                        playing = true;
                        move();

                        setTimeout(function() {
                            $("#stop").addClass("playing");
                        }, 12500);
                    }
                });

                $("#stop").click(function() {
                    if (playing) {
                        playing = false;
                        document.getElementById('track').pause();
                        $(this).css("background", "url(assets/play_small.gif) no-repeat center center");
                    }
                    else {
                        playing = true;
                        move();
                        document.getElementById('track').play();
                        $(this).css("background", "url(assets/stop.gif) no-repeat center center");

                    }
                });

                function move() {
                    if (next < times.length && times[next] < currTime) {
                        createInst(next);
                        next++;
                    }

                    $(".inst").each(function(index) {
                        if ($(this).attr("title") != selected) {
                            $(this).css("top", "-=1px");
                        }
                    });
                    if (playing) setTimeout(move, 12);
                }
            });
        </script>
    </body>
</html>
